name: Post-Deploy Health Check

on:
  workflow_run:
    workflows: ["Terraform Deploy", "Docker Build and Push"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: read

env:
  MAX_RETRIES: 10
  RETRY_DELAY: 30

jobs:
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Determine Environment URL
        run: |
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          
          if [ "$BRANCH" == "dev" ]; then
            APP_URL="https://dev.project-hub.click"
          elif [ "$BRANCH" == "staging" ]; then
            APP_URL="https://staging.project-hub.click"
          else
            APP_URL="https://project-hub.click"
          fi
          
          echo "APP_URL=$APP_URL" >> $GITHUB_ENV
          echo "Testing URL: $APP_URL"
      
      - name: Wait for ECS tasks to stabilize
        run: sleep 120
      
      - name: Check application health
        run: |
          echo "Checking health at: ${APP_URL}"
          
          for i in $(seq 1 ${{ env.MAX_RETRIES }}); do
            echo "Attempt $i of ${{ env.MAX_RETRIES }}"
            
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${APP_URL})
            
            if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 302 ] || [ "$HTTP_CODE" -eq 307 ]; then
              echo "Health check passed! HTTP $HTTP_CODE"
              exit 0
            else
              echo "Health check failed. HTTP $HTTP_CODE"
              
              if [ $i -lt ${{ env.MAX_RETRIES }} ]; then
                echo "Retrying in ${{ env.RETRY_DELAY }} seconds..."
                sleep ${{ env.RETRY_DELAY }}
              fi
            fi
          done
          
          echo "Health check failed after ${{ env.MAX_RETRIES }} attempts"
          exit 1
      
      - name: Test specific endpoints
        run: |
          curl -f ${APP_URL}/ || echo "Root endpoint check completed"